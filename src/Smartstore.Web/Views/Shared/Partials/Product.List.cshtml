@using System.Globalization;
@using Smartstore.Core.Content.Media;
@using Smartstore.Utilities;
@using Smartstore.Web.Models.Catalog;

@model ProductSummaryModel
@inject MediaSettings MediaSettings

@{
    var id = "artlist-" + CommonHelper.GenerateRandomDigitCode(10);

    // TODO: (mc) Fetch this from the (new) parent model or the product category
    var thumbAspectRatio = MediaSettings.DefaultThumbnailAspectRatio;
    var imgRatio = string.Empty;

    if (Model.ViewMode != ProductSummaryViewMode.List && thumbAspectRatio != 1 && thumbAspectRatio > 0.2 && thumbAspectRatio < 2)
    {
        imgRatio = thumbAspectRatio.ToString(CultureInfo.InvariantCulture);
    }

    var pagerHtml = HtmlString.Empty;
    //pagerHtml = await Html.PartialAsync("Product.List.Pager", Model); // TODO: (core) Uncomment
    var hasPager = pagerHtml.Value.HasValue();

    // TODO: (mc) AllowFiltering (?)
    var hasActions = Model.PagedList.TotalPages > 1
        || Model.AllowSorting
        || Model.AllowViewModeChanging
        || Model.AllowFiltering;

    var listCssClasses = new List<string> { "artlist" };
    if (Model.ViewMode == ProductSummaryViewMode.List)
    {
        listCssClasses.Add("artlist-lines");
    }
    else
    {
        listCssClasses.Add("artlist-grid");

        if (Model.BoxedStyleItems)
        {
            listCssClasses.Add("artlist-boxed");
        }

        // TODO: (mh) make 6-cols layout fit better per CSS (hide some elements etc.)
        var colspan = (int)Model.GridColumnSpan;
        listCssClasses.Add("artlist-{0}-cols".FormatInvariant(colspan));
    }
}

@if (Model.ViewMode == ProductSummaryViewMode.List)
{
    var maxPictureSize = Model.ThumbSize ?? Model.Items.Select(x => x.Image)
        .Where(x => x != null)
        .Max(x => x.ThumbSize);

    if (maxPictureSize.HasValue)
    {
        <style type="text/css">
		#@id .art-picture-block {
			width: @("{0}px".FormatInvariant(maxPictureSize.Value));
		}
        </style>
    }
}

@if (Model.PagedList.TotalCount > 0 && hasActions)
{
    <div class="artlist-actions artlist-actions--top d-flex flex-wrap" attr-style='(imgRatio.HasValue(), "--img-aspect-ratio: " + imgRatio)'>
        <div sm-if="Model.AllowSorting || Model.AllowFiltering" class="artlist-action-group artlist-action-group--filtersort">
            <partial name="Product.List.FilterSort" model="Model" />
        </div>
        <div sm-if="hasPager || Model.AllowViewModeChanging" class="artlist-action-group artlist-action-group--page">
            @* ViewMode *@
            <partial sm-if="Model.AllowViewModeChanging && Model.ViewMode == ProductSummaryViewMode.Grid || Model.ViewMode == ProductSummaryViewMode.List" 
                     name="Product.List.ViewMode" model="Model" />
            
            @* Pager *@
            @if (hasPager)
            {
                @Html.Raw(pagerHtml)
            }
        </div>
    </div>
}

@if (Model.AllowFiltering)
{
    @* TODO: (core) Impl ActiveFilters in Product.List.cshtml *@
    @*Html.RenderAction("ActiveFilters", "Search", new { area = "" });*@
    @*await Component.InvokeAsync("ActiveFilters");*@
}

<div sm-if="Model.PagedList.TotalCount > 0" id="@id" class='@string.Join(" ", listCssClasses)'>
    @foreach (var product in Model.Items)
    {
        <partial name="Product.List.Item" model="product" />
    }
</div>

<div sm-if="Model.PagedList.TotalPages > 1 && hasPager" class="artlist-actions artlist-actions--bottom">
    <div class="artlist-action-group artlist-action-group--page">
        @Html.Raw(pagerHtml)
    </div>
</div>

